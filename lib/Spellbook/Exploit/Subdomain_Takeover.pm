package Spellbook::Exploit::Subdomain_Takeover {
    use strict;
    use warnings;
    use Net::DNS;
    use LWP::UserAgent;
    use Digest::MD5 qw(md5_hex);

    sub new {
        my ($self, $parameters) = @_;
        my ($help, $target, @results);

        Getopt::Long::GetOptionsFromArray (
            $parameters,
            "h|help"     => \$help,
            "t|target=s" => \$target
        );

        if ($target) {
            $target =~ s/^http(s)?:\/\///;
            
            my $resolv = Net::DNS::Resolver -> new();
            my $reply  = $resolv -> search($target);

            if ($reply) {
                $target = "http://$target";

                foreach my $rr ($reply -> answer()) {
                    if ($rr -> can("cname")) {
                        my %hashes = (
                            "1eb970ce5a18bec7165f016df8238566" => "github.github.io",
                            "387caa8a924c5f92496824494b929207" => "heroku.com",
                            "595e88012a6521aae3e12cbebe76eb9e" => "pages.rdstation.com.br",
                            "fdda6b9858b843b34663e01f0bcce558" => "hosting.gitbook.io",
                            "6e3eb000e6dfd2ee60de7a9c53d33489" => "sslproxy.teamwork.com",
                            "308be540e2821668fb15c42317b1a256" => "wpengine.com",
                            "cb4c751c4bd5d73750c59db5621a6faa" => "shops.myshopify.com",
                            "1d9896e6c6994806305469581db3bf1d" => "proxy-ssl.webflow.com"
                            # "950b7a6e50f1f6e9c9bad5a76a90358c" => "wixdns.net",
                            # "9043fb5164b8a1a5fea8031025fe9ef8" => firebase
                        );

                        foreach (%hashes) {
                            if ($rr -> cname() =~ m/$_/) {
                                my $useragent = LWP::UserAgent -> new (ssl_opts => { verify_hostname => 0 });
                                my $request   = $useragent -> get($target);

                                if (($request -> code() == 200) || $request -> code() == 404) {
                                    my $md5 = md5_hex($request -> content());
                                    
                                    return @results, $target if $hashes{$md5};
                                }
                            }
                        }                                 
                    }
                }
            }

            return @results;
        }

        if ($help) {
            return "
                \rExploit::Subdomain_Takeover_Check
                \r==============
                \r-h, --help     See this menu
                \r-t, --target   Define a target\n\n";
        }
    }
}

1;